-- 기존 테이블 코멘트 추가
COMMENT ON COLUMN DC_BOARD_USED_TB.GOODSNAME IS '물품명';
COMMENT ON COLUMN DC_BOARD_GROUP_TB.ENDDATE IS '마감일';
COMMENT ON COLUMN DC_BOARD_GROUP_TB.GOODSNAME IS '물품명';


-- 공동구매, 중고거래 테이블 컬럼 추가
ALTER TABLE DC_BOARD_GROUP_TB ADD (GOODSPICTURE VARCHAR2(100));
COMMENT ON COLUMN DC_BOARD_GROUP_TB.GOODSPICTURE IS '물품 사진';
ALTER TABLE DC_BOARD_USED_TB ADD (GOODSPICTURE VARCHAR2(100));
COMMENT ON COLUMN DC_BOARD_USED_TB.GOODSPICTURE IS '물품 사진';
ALTER TABLE DC_BOARD_GROUP_TB ADD(BANK VARCHAR2(50));
COMMENT ON COLUMN DC_BOARD_GROUP_TB.BANK IS '사용자 은행';
ALTER TABLE DC_USED_HISTORY_TB ADD (STATUS VARCHAR2(50));
COMMENT ON COLUMN DC_USED_HISTORY_TB.STATUS IS '승인,지급 등';

ALTER TABLE DC_BOARD_GROUP_TB ADD CONSTRAINT FK_CODE_TO_GROUP_3 FOREIGN KEY (
   BANK
)
REFERENCES DC_CODE_TB (
   ID
);

ALTER TABLE DC_USED_HISTORY_TB ADD CONSTRAINT FK_CODE_TO_USED_HISTORY_1 FOREIGN KEY (
   STATUS
)
REFERENCES DC_CODE_TB (
   ID
);


-- 코드 테이블 추가
INSERT INTO DC_CODE_TB VALUES('GROUP001', '참여자모집' ,'공동구매상태');
INSERT INTO DC_CODE_TB VALUES('GROUP002', '모집완료' ,'공동구매상태');
INSERT INTO DC_CODE_TB VALUES('GROUP003', '입금완료' ,'공동구매상태');
INSERT INTO DC_CODE_TB VALUES('GROUP004', '공구완료' ,'공동구매상태');
INSERT INTO DC_CODE_TB VALUES('GROUP005', '기간만료' ,'공동구매상태');

INSERT INTO DC_CODE_TB VALUES('USED001', '판매중' ,'중고거래상태');
INSERT INTO DC_CODE_TB VALUES('USED002', '판매완료' ,'중고거래상태');
INSERT INTO DC_CODE_TB VALUES('USED003', '판매중지' ,'중고거래상태');

INSERT INTO DC_CODE_TB VALUES('USEDHIT001', '결제완료' ,'중고거래결제상태');
INSERT INTO DC_CODE_TB VALUES('USEDHIT002', '물품인계' ,'중고거래결제상태');
INSERT INTO DC_CODE_TB VALUES('USEDHIT003', '인계확인' ,'중고거래결제상태');
INSERT INTO DC_CODE_TB VALUES('USEDHIT004', '거래완료' ,'중고거래결제상태');
INSERT INTO DC_CODE_TB VALUES('USEDHIT005', '거래취소' ,'중고거래결제상태');
INSERT INTO DC_CODE_TB VALUES('USEDHIT006', '거래중지' ,'중고거래결제상태');

INSERT INTO DC_CODE_TB VALUES('DEAL001', '직거래' ,'거래타입');
INSERT INTO DC_CODE_TB VALUES('DEAL002', '택배' ,'거래타입');
INSERT INTO DC_CODE_TB VALUES('DEAL003', '안전거래' ,'거래타입');


-- 뷰 생성
CREATE OR REPLACE VIEW DC_BOARD_GROUP_VIEW
AS
SELECT G.NO, G.BOARDNO, G.GOODSNAME, G.PRICE, G.ENDDATE, G.DEPOSIT, G.GOODSPICTURE,
    G.MAXCOUNT, B.TITLE, B.CONTENT, B.WRITEDATE,B.VIEWCOUNT, B.STATUS, B.MEMBERNO,
    (SELECT COUNT(*) FROM DC_GROUP_HISTORY_TB WHERE GROUPNO=G.NO)CURRENTCOUNT,
    (SELECT NAME FROM DC_GOODS_CATEGORY_TB GC WHERE GC.NO=G.GOODSNO)GOODSCATEGORY,
    (SELECT NICKNAME FROM DC_MEMBER_TB M WHERE M.NO=B.MEMBERNO) MEMBER,
    (SELECT VALUE FROM DC_CODE_TB C WHERE C.ID=G.STATUS) GSTATUS,
    (SELECT VALUE FROM DC_CODE_TB C WHERE C.ID=G.DEALTYPE) DEALTYPE
FROM DC_BOARD_GROUP_TB G 
JOIN DC_BOARD_TB B ON (G.BOARDNO=B.NO)
WITH READ ONLY;

CREATE OR REPLACE VIEW DC_BOARD_USED_VIEW
AS
SELECT U.NO, U.BOARDNO, U.PRICE, U.GOODSNAME, U.GOODSPICTURE, 
    B.TITLE, B.CONTENT, B.WRITEDATE,B.VIEWCOUNT, B.STATUS, B.MEMBERNO,
    (SELECT NICKNAME FROM DC_MEMBER_TB M WHERE M.NO=B.MEMBERNO) MEMBER,
    (SELECT NAME FROM DC_GOODS_CATEGORY_TB GC WHERE GC.NO=U.GOODSNO)GOODSCATEGORY,
    (SELECT VALUE FROM DC_CODE_TB C WHERE C.ID=U.DEALTYPE) DEALTYPE,
    (SELECT VALUE FROM DC_CODE_TB C WHERE C.ID=U.STATUS) USTATUS
FROM DC_BOARD_USED_TB U
JOIN DC_BOARD_TB B ON (U.BOARDNO=B.NO)
WITH READ ONLY;


-- 트리거
CREATE OR REPLACE TRIGGER GROUP_HISTORY_TRG1
AFTER INSERT ON DC_GROUP_HISTORY_TB
DECLARE
    CUR_GROUPNO NUMBER;
    CUR_COUNT NUMBER;
    MAX_COUNT NUMBER;
BEGIN
    SELECT GROUPNO INTO CUR_GROUPNO 
    FROM (SELECT * FROM DC_GROUP_HISTORY_TB ORDER BY NO DESC) WHERE ROWNUM = 1;
    SELECT COUNT(*) INTO CUR_COUNT FROM DC_GROUP_HISTORY_TB WHERE GROUPNO = CUR_GROUPNO;
    SELECT MAXCOUNT INTO MAX_COUNT FROM DC_BOARD_GROUP_TB WHERE NO = CUR_GROUPNO;

    IF (CUR_COUNT = MAX_COUNT)
     THEN UPDATE DC_BOARD_GROUP_TB SET STATUS='GROUP002' WHERE NO = CUR_GROUPNO;
    END IF;
END;







-------------------------
-------------------------
-------------------------
-------------------------
-- 지면 추가
INSERT INTO DC_AD_LOCATION_TB VALUES(SEQ_AD_LOCATION.NEXTVAL,'중앙',NULL);
COMMIT;

ALTER TABLE DC_AD_SECTION_TB ADD (ENAME VARCHAR2(50));
INSERT INTO DC_AD_SECTION_TB VALUES(SEQ_AD_SECTION.NEXTVAL,'중앙',NULL);
COMMIT;


ALTER TABLE DC_AD_PAGE_TB ADD ENAME VARCHAR(50);
INSERT INTO DC_AD_PAGE_TB VALUES (SEQ_AD_PAGE.NEXTVAL, '관리자', NULL);
COMMIT;

